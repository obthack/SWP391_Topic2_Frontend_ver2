<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat Realtime - SignalR</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
            border: 2px solid #fcc;
        }

        .status.connecting {
            background: #ffeaa7;
            color: #d63031;
            border: 2px solid #fdcb6e;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .messages {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .message.sent {
            background: #c8e6c9;
            border-left-color: #4caf50;
        }

        .message .time {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .logs {
            background: #263238;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff5252;
        }

        .log-entry.success {
            color: #4caf50;
        }

        .log-entry.info {
            color: #00bcd4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Test Chat Realtime - SignalR</h1>
        <p class="subtitle">Tool test k·∫øt n·ªëi SignalR v√† g·ª≠i/nh·∫≠n tin nh·∫Øn realtime</p>

        <!-- Status -->
        <div id="status" class="status disconnected">
            üî¥ Ch∆∞a k·∫øt n·ªëi
        </div>

        <!-- Connection Section -->
        <div class="section">
            <h2>1Ô∏è‚É£ K·∫øt N·ªëi SignalR</h2>
            <div class="input-group">
                <label>Backend URL:</label>
                <input type="text" id="backendUrl" value="http://localhost:5044" placeholder="http://localhost:5044">
            </div>
            <div class="input-group">
                <label>Token (t·ª´ localStorage evtb_auth):</label>
                <input type="text" id="token" placeholder="Paste JWT token ·ªü ƒë√¢y...">
            </div>
            <button id="connectBtn" onclick="connectSignalR()">üîå K·∫øt N·ªëi</button>
            <button id="disconnectBtn" onclick="disconnectSignalR()" disabled>üî¥ Ng·∫Øt K·∫øt N·ªëi</button>
        </div>

        <!-- Join Chat Section -->
        <div class="section">
            <h2>2Ô∏è‚É£ Join Chat Room</h2>
            <div class="input-group">
                <label>Chat ID:</label>
                <input type="number" id="chatId" placeholder="1" value="1">
            </div>
            <button onclick="joinChat()" disabled id="joinBtn">üö™ Join Chat</button>
            <button onclick="leaveChat()" disabled id="leaveBtn">üëã Leave Chat</button>
        </div>

        <!-- Send Message Section -->
        <div class="section">
            <h2>3Ô∏è‚É£ G·ª≠i Tin Nh·∫Øn</h2>
            <div class="input-group">
                <label>Sender ID (User ID c·ªßa b·∫°n):</label>
                <input type="number" id="senderId" placeholder="1" value="1">
            </div>
            <div class="input-group">
                <label>N·ªôi dung tin nh·∫Øn:</label>
                <textarea id="messageContent" rows="3" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
            </div>
            <button onclick="sendMessage()" disabled id="sendBtn">üì§ G·ª≠i Tin Nh·∫Øn</button>
        </div>

        <!-- Messages -->
        <div class="section">
            <h2>4Ô∏è‚É£ Tin Nh·∫Øn Nh·∫≠n ƒê∆∞·ª£c</h2>
            <div id="messages" class="messages">
                <p style="color: #999; text-align: center;">Ch∆∞a c√≥ tin nh·∫Øn n√†o...</p>
            </div>
        </div>

        <!-- Logs -->
        <div class="section">
            <h2>üìã Console Logs</h2>
            <div id="logs" class="logs">
                <div class="log-entry">S·∫µn s√†ng test SignalR...</div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentChatId = null;

        // Auto-fill token from localStorage
        window.addEventListener('load', () => {
            try {
                const authData = localStorage.getItem('evtb_auth');
                if (authData) {
                    const token = JSON.parse(authData).token;
                    document.getElementById('token').value = token;
                    log('‚úÖ Token ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông load t·ª´ localStorage', 'success');
                }
            } catch (e) {
                log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y token trong localStorage', 'info');
            }
        });

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logs.insertBefore(entry, logs.firstChild);
            console.log(message);
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        async function connectSignalR() {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                const token = document.getElementById('token').value;

                if (!token) {
                    alert('Vui l√≤ng nh·∫≠p token!');
                    return;
                }

                updateStatus('connecting', 'üü° ƒêang k·∫øt n·ªëi...');
                log('üîå B·∫Øt ƒë·∫ßu k·∫øt n·ªëi SignalR...', 'info');

                connection = new signalR.HubConnectionBuilder()
                    .withUrl(`${backendUrl}/chatHub`, {
                        accessTokenFactory: () => token,
                        skipNegotiation: false,
                        transport: signalR.HttpTransportType.WebSockets | 
                                   signalR.HttpTransportType.ServerSentEvents | 
                                   signalR.HttpTransportType.LongPolling
                    })
                    .withAutomaticReconnect()
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                // Setup event handlers
                connection.on("ReceiveMessage", (message) => {
                    log(`üì® Nh·∫≠n tin nh·∫Øn: ${JSON.stringify(message)}`, 'success');
                    displayMessage(message, false);
                });

                connection.on("UserJoined", (info) => {
                    log(`üëã User joined: ${info}`, 'info');
                });

                connection.on("UserLeft", (info) => {
                    log(`üëã User left: ${info}`, 'info');
                });

                connection.onclose(() => {
                    updateStatus('disconnected', 'üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                    log('üî¥ K·∫øt n·ªëi b·ªã ƒë√≥ng', 'error');
                    toggleButtons(false);
                });

                connection.onreconnecting(() => {
                    updateStatus('connecting', 'üü° ƒêang k·∫øt n·ªëi l·∫°i...');
                    log('üîÑ ƒêang reconnect...', 'info');
                });

                connection.onreconnected(() => {
                    updateStatus('connected', 'üü¢ ƒê√£ k·∫øt n·ªëi (Reconnected)');
                    log('‚úÖ Reconnected th√†nh c√¥ng!', 'success');
                    // Rejoin chat if was in one
                    if (currentChatId) {
                        joinChat();
                    }
                });

                // Start connection
                await connection.start();
                updateStatus('connected', 'üü¢ ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng!');
                log('‚úÖ K·∫øt n·ªëi SignalR th√†nh c√¥ng!', 'success');
                log(`üìä Connection ID: ${connection.connectionId}`, 'info');
                toggleButtons(true);

            } catch (error) {
                updateStatus('disconnected', 'üî¥ L·ªói k·∫øt n·ªëi');
                log(`‚ùå L·ªói: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function disconnectSignalR() {
            if (connection) {
                await connection.stop();
                connection = null;
                currentChatId = null;
                updateStatus('disconnected', 'üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi');
                log('üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi', 'info');
                toggleButtons(false);
            }
        }

        async function joinChat() {
            if (!connection) {
                alert('Vui l√≤ng k·∫øt n·ªëi SignalR tr∆∞·ªõc!');
                return;
            }

            const chatId = document.getElementById('chatId').value;
            if (!chatId) {
                alert('Vui l√≤ng nh·∫≠p Chat ID!');
                return;
            }

            try {
                // Leave previous chat
                if (currentChatId && currentChatId !== chatId) {
                    await connection.invoke("LeaveChat", currentChatId);
                    log(`üëã Left chat: ${currentChatId}`, 'info');
                }

                // Join new chat
                await connection.invoke("JoinChat", chatId);
                currentChatId = chatId;
                log(`‚úÖ Joined chat: ${chatId}`, 'success');
                document.getElementById('leaveBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            } catch (error) {
                log(`‚ùå L·ªói join chat: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function leaveChat() {
            if (!connection || !currentChatId) return;

            try {
                await connection.invoke("LeaveChat", currentChatId);
                log(`üëã Left chat: ${currentChatId}`, 'info');
                currentChatId = null;
                document.getElementById('leaveBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            } catch (error) {
                log(`‚ùå L·ªói leave chat: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function sendMessage() {
            const chatId = document.getElementById('chatId').value;
            const senderId = document.getElementById('senderId').value;
            const content = document.getElementById('messageContent').value;

            if (!content.trim()) {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung tin nh·∫Øn!');
                return;
            }

            try {
                const backendUrl = document.getElementById('backendUrl').value;
                const token = document.getElementById('token').value;

                log(`üì§ ƒêang g·ª≠i tin nh·∫Øn...`, 'info');

                const response = await fetch(`${backendUrl}/api/Message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        chatId: parseInt(chatId),
                        senderId: parseInt(senderId),
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                log(`‚úÖ Tin nh·∫Øn ƒë√£ g·ª≠i: ${JSON.stringify(data)}`, 'success');
                displayMessage(data, true);
                document.getElementById('messageContent').value = '';

            } catch (error) {
                log(`‚ùå L·ªói g·ª≠i tin nh·∫Øn: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function displayMessage(message, isSent) {
            const messagesDiv = document.getElementById('messages');
            
            // Clear placeholder
            if (messagesDiv.querySelector('p')) {
                messagesDiv.innerHTML = '';
            }

            const messageEl = document.createElement('div');
            messageEl.className = `message ${isSent ? 'sent' : ''}`;
            messageEl.innerHTML = `
                <strong>${isSent ? 'B·∫°n' : `User ${message.senderId}`}:</strong> ${message.content}
                <div class="time">${new Date(message.createdDate || new Date()).toLocaleString()}</div>
            `;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function toggleButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('joinBtn').disabled = !connected;
            if (!connected) {
                document.getElementById('leaveBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        }
    </script>
</body>
</html>

