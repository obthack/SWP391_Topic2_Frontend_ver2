<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Verification Payment Notifications</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .debug-section h3 {
            color: #374151;
            margin-bottom: 15px;
        }
        .debug-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .debug-button:hover {
            background: #1d4ed8;
        }
        .debug-button.success {
            background: #059669;
        }
        .debug-button.success:hover {
            background: #047857;
        }
        .debug-button.warning {
            background: #d97706;
        }
        .debug-button.warning:hover {
            background: #b45309;
        }
        .debug-button.danger {
            background: #dc2626;
        }
        .debug-button.danger:hover {
            background: #b91c1c;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        .result.error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        .result.info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }
        .result.warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.success {
            background: #10b981;
        }
        .status-indicator.error {
            background: #ef4444;
        }
        .status-indicator.warning {
            background: #f59e0b;
        }
        .status-indicator.info {
            background: #3b82f6;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .payment-table th,
        .payment-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .payment-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .payment-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .payment-table tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Debug Verification Payment Notifications</h1>
            <p>Ki·ªÉm tra v√† g·ª≠i th√¥ng b√°o cho c√°c thanh to√°n ki·ªÉm ƒë·ªãnh ƒë√£ th√†nh c√¥ng</p>
        </div>

        <div class="debug-section">
            <h3>üîç Step 1: Ki·ªÉm tra thanh to√°n ki·ªÉm ƒë·ªãnh trong database</h3>
            <button class="debug-button" onclick="checkVerificationPayments()">
                Ki·ªÉm tra thanh to√°n ki·ªÉm ƒë·ªãnh
            </button>
            <button class="debug-button success" onclick="checkAdminNotifications()">
                Ki·ªÉm tra th√¥ng b√°o admin
            </button>
            <div id="payment-check-result" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>üîî Step 2: G·ª≠i th√¥ng b√°o cho thanh to√°n ƒë√£ th√†nh c√¥ng</h3>
            <button class="debug-button warning" onclick="sendNotificationsForSuccessfulPayments()">
                G·ª≠i th√¥ng b√°o cho t·∫•t c·∫£ thanh to√°n th√†nh c√¥ng
            </button>
            <button class="debug-button" onclick="sendNotificationForSpecificPayment()">
                G·ª≠i th√¥ng b√°o cho thanh to√°n c·ª• th·ªÉ
            </button>
            <div id="notification-send-result" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>üõ†Ô∏è Step 3: Debug v√† s·ª≠a l·ªói</h3>
            <button class="debug-button" onclick="debugAdminUser()">
                Debug Admin User
            </button>
            <button class="debug-button" onclick="debugNotificationAPI()">
                Debug Notification API
            </button>
            <button class="debug-button danger" onclick="clearAllNotifications()">
                X√≥a t·∫•t c·∫£ th√¥ng b√°o (Test)
            </button>
            <div id="debug-result" class="result" style="display: none;"></div>
        </div>

        <div class="debug-section">
            <h3>üìä Step 4: Ki·ªÉm tra k·∫øt qu·∫£</h3>
            <button class="debug-button success" onclick="refreshAdminDashboard()">
                L√†m m·ªõi Admin Dashboard
            </button>
            <button class="debug-button" onclick="openAdminDashboard()">
                M·ªü Admin Dashboard
            </button>
            <div id="result-check" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        const FRONTEND_BASE = 'http://localhost:5173';

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = message;
        }

        async function checkVerificationPayments() {
            try {
                showResult('payment-check-result', 'ƒêang ki·ªÉm tra thanh to√°n ki·ªÉm ƒë·ªãnh...', 'info');
                
                const response = await fetch(`${API_BASE}/Payment`);
                
                if (response.ok) {
                    const payments = await response.json();
                    const verificationPayments = payments.filter(p => p.PaymentType === 'Verification');
                    const successfulPayments = verificationPayments.filter(p => p.PaymentStatus === 'Success');
                    
                    let result = `‚úÖ T√¨m th·∫•y ${verificationPayments.length} thanh to√°n ki·ªÉm ƒë·ªãnh:\n\n`;
                    result += `- Th√†nh c√¥ng: ${successfulPayments.length}\n`;
                    result += `- Th·∫•t b·∫°i: ${verificationPayments.length - successfulPayments.length}\n\n`;
                    
                    if (successfulPayments.length > 0) {
                        result += `üìã Chi ti·∫øt thanh to√°n th√†nh c√¥ng:\n`;
                        result += `ID\t\tProductId\tAmount\t\tStatus\t\tCreatedAt\n`;
                        result += `---\t\t---------\t------\t\t------\t\t---------\n`;
                        
                        successfulPayments.forEach(payment => {
                            result += `${payment.PaymentId}\t${payment.ProductId}\t\t${payment.Amount}\t\t${payment.PaymentStatus}\t\t${payment.CreatedAt}\n`;
                        });
                    }
                    
                    showResult('payment-check-result', result, 'success');
                } else {
                    const error = await response.text();
                    showResult('payment-check-result', `‚ùå L·ªói: ${error}`, 'error');
                }
            } catch (error) {
                showResult('payment-check-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function checkAdminNotifications() {
            try {
                showResult('payment-check-result', 'ƒêang ki·ªÉm tra th√¥ng b√°o admin...', 'info');
                
                // First get admin user ID
                const usersResponse = await fetch(`${API_BASE}/User`);
                const users = await usersResponse.json();
                const adminUser = users.find(user => 
                    user.role === 'admin' || 
                    user.role === 'Admin' || 
                    user.isAdmin === true ||
                    user.email?.includes('admin') ||
                    user.fullName?.includes('Admin')
                );
                
                const adminUserId = adminUser ? (adminUser.id || adminUser.userId || adminUser.accountId) : (users[0]?.id || users[0]?.userId || users[0]?.accountId || 1);
                
                const response = await fetch(`${API_BASE}/Notification/user/${adminUserId}`);
                
                if (response.ok) {
                    const notifications = await response.json();
                    const verificationNotifications = notifications.filter(n => n.notificationType === 'verification_payment_success');
                    const unreadNotifications = notifications.filter(n => !n.isRead);
                    
                    let result = `‚úÖ Th√¥ng b√°o admin (User ID: ${adminUserId}):\n\n`;
                    result += `- T·ªïng th√¥ng b√°o: ${notifications.length}\n`;
                    result += `- Ch∆∞a ƒë·ªçc: ${unreadNotifications.length}\n`;
                    result += `- Th√¥ng b√°o ki·ªÉm ƒë·ªãnh: ${verificationNotifications.length}\n\n`;
                    
                    if (verificationNotifications.length > 0) {
                        result += `üìã Chi ti·∫øt th√¥ng b√°o ki·ªÉm ƒë·ªãnh:\n`;
                        verificationNotifications.forEach(notification => {
                            result += `- ${notification.title}\n`;
                            result += `  Content: ${notification.content}\n`;
                            result += `  Created: ${notification.createdAt}\n`;
                            result += `  Read: ${notification.isRead ? 'Yes' : 'No'}\n\n`;
                        });
                    }
                    
                    showResult('payment-check-result', result, 'success');
                } else {
                    const error = await response.text();
                    showResult('payment-check-result', `‚ùå L·ªói: ${error}`, 'error');
                }
            } catch (error) {
                showResult('payment-check-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function sendNotificationsForSuccessfulPayments() {
            try {
                showResult('notification-send-result', 'ƒêang g·ª≠i th√¥ng b√°o cho thanh to√°n th√†nh c√¥ng...', 'info');
                
                // Get all successful verification payments
                const paymentsResponse = await fetch(`${API_BASE}/Payment`);
                const payments = await paymentsResponse.json();
                const successfulPayments = payments.filter(p => 
                    p.PaymentType === 'Verification' && 
                    p.PaymentStatus === 'Success' && 
                    p.ProductId
                );
                
                // Get admin user ID
                const usersResponse = await fetch(`${API_BASE}/User`);
                const users = await usersResponse.json();
                const adminUser = users.find(user => 
                    user.role === 'admin' || 
                    user.role === 'Admin' || 
                    user.isAdmin === true ||
                    user.email?.includes('admin') ||
                    user.fullName?.includes('Admin')
                );
                const adminUserId = adminUser ? (adminUser.id || adminUser.userId || adminUser.accountId) : (users[0]?.id || users[0]?.userId || users[0]?.accountId || 1);
                
                let result = `üîî G·ª≠i th√¥ng b√°o cho ${successfulPayments.length} thanh to√°n th√†nh c√¥ng:\n\n`;
                let successCount = 0;
                
                for (const payment of successfulPayments) {
                    try {
                        // Get product info
                        const productResponse = await fetch(`${API_BASE}/Product/${payment.ProductId}`);
                        const product = productResponse.ok ? await productResponse.json() : { title: 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh' };
                        
                        // Get seller info
                        const sellerResponse = await fetch(`${API_BASE}/User/${payment.UserId}`);
                        const seller = sellerResponse.ok ? await sellerResponse.json() : { fullName: 'Ng∆∞·ªùi b√°n kh√¥ng x√°c ƒë·ªãnh' };
                        
                        // Create notification
                        const notificationData = {
                            userId: adminUserId,
                            notificationType: 'verification_payment_success',
                            title: 'üí∞ Thanh to√°n ki·ªÉm ƒë·ªãnh th√†nh c√¥ng',
                            content: `S·∫£n ph·∫©m "${product.title || product.name || 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh'}" (ID: ${payment.ProductId}) c·ªßa ng∆∞·ªùi b√°n "${seller.fullName || seller.name || seller.full_name || 'Ng∆∞·ªùi b√°n kh√¥ng x√°c ƒë·ªãnh'}" ƒë√£ thanh to√°n ${payment.Amount.toLocaleString('vi-VN')} VNƒê cho d·ªãch v·ª• ki·ªÉm ƒë·ªãnh. Vui l√≤ng th·ª±c hi·ªán ki·ªÉm ƒë·ªãnh xe.`,
                            metadata: {
                                productId: payment.ProductId,
                                sellerName: seller.fullName || seller.name || seller.full_name || 'Ng∆∞·ªùi b√°n kh√¥ng x√°c ƒë·ªãnh',
                                amount: payment.Amount,
                                actionRequired: 'inspection'
                            }
                        };
                        
                        const notificationResponse = await fetch(`${API_BASE}/Notification`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(notificationData)
                        });
                        
                        if (notificationResponse.ok) {
                            result += `‚úÖ Payment ${payment.PaymentId}: Notification sent successfully\n`;
                            successCount++;
                        } else {
                            result += `‚ùå Payment ${payment.PaymentId}: Failed to send notification\n`;
                        }
                    } catch (error) {
                        result += `‚ùå Payment ${payment.PaymentId}: Error - ${error.message}\n`;
                    }
                }
                
                result += `\nüìä K·∫øt qu·∫£: ${successCount}/${successfulPayments.length} th√¥ng b√°o ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng`;
                
                showResult('notification-send-result', result, successCount > 0 ? 'success' : 'error');
            } catch (error) {
                showResult('notification-send-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function sendNotificationForSpecificPayment() {
            const paymentId = prompt('Nh·∫≠p Payment ID c·∫ßn g·ª≠i th√¥ng b√°o:');
            if (!paymentId) return;
            
            try {
                showResult('notification-send-result', `ƒêang g·ª≠i th√¥ng b√°o cho Payment ID: ${paymentId}...`, 'info');
                
                // Get payment details
                const paymentResponse = await fetch(`${API_BASE}/Payment/${paymentId}`);
                if (!paymentResponse.ok) {
                    showResult('notification-send-result', `‚ùå Kh√¥ng t√¨m th·∫•y payment v·ªõi ID: ${paymentId}`, 'error');
                    return;
                }
                
                const payment = await paymentResponse.json();
                
                if (payment.PaymentType !== 'Verification' || payment.PaymentStatus !== 'Success') {
                    showResult('notification-send-result', `‚ùå Payment ${paymentId} kh√¥ng ph·∫£i l√† thanh to√°n ki·ªÉm ƒë·ªãnh th√†nh c√¥ng`, 'error');
                    return;
                }
                
                // Get admin user ID
                const usersResponse = await fetch(`${API_BASE}/User`);
                const users = await usersResponse.json();
                const adminUser = users.find(user => 
                    user.role === 'admin' || 
                    user.role === 'Admin' || 
                    user.isAdmin === true ||
                    user.email?.includes('admin') ||
                    user.fullName?.includes('Admin')
                );
                const adminUserId = adminUser ? (adminUser.id || adminUser.userId || adminUser.accountId) : (users[0]?.id || users[0]?.userId || users[0]?.accountId || 1);
                
                // Get product and seller info
                const productResponse = await fetch(`${API_BASE}/Product/${payment.ProductId}`);
                const product = productResponse.ok ? await productResponse.json() : { title: 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh' };
                
                const sellerResponse = await fetch(`${API_BASE}/User/${payment.UserId}`);
                const seller = sellerResponse.ok ? await sellerResponse.json() : { fullName: 'Ng∆∞·ªùi b√°n kh√¥ng x√°c ƒë·ªãnh' };
                
                // Create notification
                const notificationData = {
                    userId: adminUserId,
                    notificationType: 'verification_payment_success',
                    title: 'üí∞ Thanh to√°n ki·ªÉm ƒë·ªãnh th√†nh c√¥ng',
                    content: `S·∫£n ph·∫©m "${product.title || product.name || 'S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh'}" (ID: ${payment.ProductId}) c·ªßa ng∆∞·ªùi b√°n "${seller.fullName || seller.name || seller.full_name || 'Ng∆∞·ªùi b√°n kh√¥ng x√°c ƒë·ªãnh'}" ƒë√£ thanh to√°n ${payment.Amount.toLocaleString('vi-VN')} VNƒê cho d·ªãch v·ª• ki·ªÉm ƒë·ªãnh. Vui l√≤ng th·ª±c hi·ªán ki·ªÉm ƒë·ªãnh xe.`,
                    metadata: {
                        productId: payment.ProductId,
                        sellerName: seller.fullName || seller.name || seller.full_name || 'Ng∆∞·ªùi b√°n kh√¥ng x√°c ƒë·ªãnh',
                        amount: payment.Amount,
                        actionRequired: 'inspection'
                    }
                };
                
                const notificationResponse = await fetch(`${API_BASE}/Notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(notificationData)
                });
                
                if (notificationResponse.ok) {
                    const result = await notificationResponse.json();
                    showResult('notification-send-result', `‚úÖ Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!\n\nResponse: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const error = await notificationResponse.text();
                    showResult('notification-send-result', `‚ùå L·ªói g·ª≠i th√¥ng b√°o: ${error}`, 'error');
                }
            } catch (error) {
                showResult('notification-send-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function debugAdminUser() {
            try {
                showResult('debug-result', 'ƒêang debug admin user...', 'info');
                
                const response = await fetch(`${API_BASE}/User`);
                const users = await response.json();
                
                let result = `üë• T·∫•t c·∫£ users (${users.length}):\n\n`;
                users.forEach((user, index) => {
                    result += `${index + 1}. ID: ${user.id || user.userId || user.accountId}\n`;
                    result += `   Name: ${user.fullName || user.name || user.full_name || 'N/A'}\n`;
                    result += `   Email: ${user.email || 'N/A'}\n`;
                    result += `   Role: ${user.role || 'N/A'}\n`;
                    result += `   IsAdmin: ${user.isAdmin || false}\n\n`;
                });
                
                const adminUser = users.find(user => 
                    user.role === 'admin' || 
                    user.role === 'Admin' || 
                    user.isAdmin === true ||
                    user.email?.includes('admin') ||
                    user.fullName?.includes('Admin')
                );
                
                if (adminUser) {
                    result += `‚úÖ Admin user found:\n`;
                    result += `ID: ${adminUser.id || adminUser.userId || adminUser.accountId}\n`;
                    result += `Name: ${adminUser.fullName || adminUser.name || adminUser.full_name}\n`;
                    result += `Email: ${adminUser.email}\n`;
                } else {
                    result += `‚ö†Ô∏è No admin user found, will use first user as admin\n`;
                    result += `Admin ID will be: ${users[0]?.id || users[0]?.userId || users[0]?.accountId || 1}\n`;
                }
                
                showResult('debug-result', result, 'info');
            } catch (error) {
                showResult('debug-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function debugNotificationAPI() {
            try {
                showResult('debug-result', 'ƒêang debug notification API...', 'info');
                
                // Test creating a simple notification
                const testNotification = {
                    userId: 1,
                    notificationType: 'test',
                    title: 'Test Notification',
                    content: 'This is a test notification to verify API is working'
                };
                
                const response = await fetch(`${API_BASE}/Notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testNotification)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showResult('debug-result', `‚úÖ Notification API is working!\n\nResponse: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const error = await response.text();
                    showResult('debug-result', `‚ùå Notification API error: ${error}`, 'error');
                }
            } catch (error) {
                showResult('debug-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        async function clearAllNotifications() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ th√¥ng b√°o? (Ch·ªâ d√πng ƒë·ªÉ test)')) {
                return;
            }
            
            try {
                showResult('debug-result', 'ƒêang x√≥a t·∫•t c·∫£ th√¥ng b√°o...', 'warning');
                
                // Get all users and delete their notifications
                const usersResponse = await fetch(`${API_BASE}/User`);
                const users = await usersResponse.json();
                
                let deletedCount = 0;
                
                for (const user of users) {
                    const userId = user.id || user.userId || user.accountId;
                    const notificationsResponse = await fetch(`${API_BASE}/Notification/user/${userId}`);
                    
                    if (notificationsResponse.ok) {
                        const notifications = await notificationsResponse.json();
                        
                        for (const notification of notifications) {
                            const deleteResponse = await fetch(`${API_BASE}/Notification/${notification.id || notification.notificationId}`, {
                                method: 'DELETE'
                            });
                            
                            if (deleteResponse.ok) {
                                deletedCount++;
                            }
                        }
                    }
                }
                
                showResult('debug-result', `‚úÖ ƒê√£ x√≥a ${deletedCount} th√¥ng b√°o`, 'success');
            } catch (error) {
                showResult('debug-result', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        function refreshAdminDashboard() {
            showResult('result-check', 'ƒêang l√†m m·ªõi Admin Dashboard...', 'info');
            
            // Open admin dashboard in new tab
            const adminUrl = `${FRONTEND_BASE}/admin`;
            window.open(adminUrl, '_blank');
            
            showResult('result-check', `‚úÖ Admin Dashboard ƒë√£ ƒë∆∞·ª£c m·ªü trong tab m·ªõi\n\nURL: ${adminUrl}\n\nVui l√≤ng ki·ªÉm tra:\n- Bell icon c√≥ hi·ªÉn th·ªã s·ªë th√¥ng b√°o kh√¥ng\n- Dropdown th√¥ng b√°o c√≥ hi·ªÉn th·ªã th√¥ng b√°o ki·ªÉm ƒë·ªãnh kh√¥ng\n- Stats cards c√≥ c·∫≠p nh·∫≠t kh√¥ng`, 'success');
        }

        function openAdminDashboard() {
            window.open(`${FRONTEND_BASE}/admin`, '_blank');
        }
    </script>
</body>
</html>

