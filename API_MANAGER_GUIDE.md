# API Manager - H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng

## üìã T·ªïng Quan

File `src/api/apiManager.js` t·ªïng h·ª£p **T·∫§T C·∫¢** c√°c API endpoint c·ªßa h·ªá th·ªëng v√†o m·ªôt n∆°i duy nh·∫•t, gi√∫p:
- ‚úÖ D·ªÖ d√†ng qu·∫£n l√Ω v√† b·∫£o tr√¨
- ‚úÖ Tr√°nh tr√πng l·∫∑p code
- ‚úÖ C·∫•u tr√∫c r√µ r√†ng, d·ªÖ t√¨m ki·∫øm
- ‚úÖ Type-safe v·ªõi JSDoc comments
- ‚úÖ T·ª± ƒë·ªông x·ª≠ l√Ω authentication token

## üóÇÔ∏è C·∫•u Tr√∫c API

API ƒë∆∞·ª£c t·ªï ch·ª©c theo 15 modules ch√≠nh:

1. **authAPI** - X√°c th·ª±c ng∆∞·ªùi d√πng
2. **userAPI** - Qu·∫£n l√Ω ng∆∞·ªùi d√πng
3. **productAPI** - Qu·∫£n l√Ω s·∫£n ph·∫©m
4. **orderAPI** - Qu·∫£n l√Ω ƒë∆°n h√†ng
5. **paymentAPI** - Thanh to√°n
6. **favoriteAPI** - Y√™u th√≠ch
7. **notificationAPI** - Th√¥ng b√°o
8. **chatAPI** - Chat/Tin nh·∫Øn
9. **reviewAPI** - ƒê√°nh gi√°
10. **verificationAPI** - X√°c minh xe
11. **statisticsAPI** - Th·ªëng k√™
12. **searchAPI** - T√¨m ki·∫øm
13. **categoryAPI** - Danh m·ª•c
14. **systemAPI** - H·ªá th·ªëng

## üöÄ C√°ch S·ª≠ D·ª•ng

### C√°ch 1: Import API Object (Khuy·∫øn Ngh·ªã)

```javascript
import api from '@/api';

// Authentication
const loginResponse = await api.auth.login({ email, password });
const registerResponse = await api.auth.register(userData);

// Products
const products = await api.product.getAll();
const product = await api.product.getById(productId);
const newProduct = await api.product.create(productData);

// Orders
const orders = await api.order.getByUser(userId);
const newOrder = await api.order.create(orderData);

// Payments
const payment = await api.payment.create(paymentData);
await api.payment.processVNPay(paymentData);

// Favorites
await api.favorite.toggle(userId, productId);
const isFavorited = await api.favorite.isFavorited(userId, productId);

// Notifications
const notifications = await api.notification.getByUser(userId);
await api.notification.markAsRead(notificationId);

// Statistics
const dashboardStats = await api.statistics.getDashboard(userId);
const adminStats = await api.statistics.getAdmin();
```

### C√°ch 2: Import Specific Modules

```javascript
import { authAPI, productAPI, orderAPI } from '@/api';

// S·ª≠ d·ª•ng tr·ª±c ti·∫øp
const products = await productAPI.getAll();
const loginResponse = await authAPI.login({ email, password });
const orders = await orderAPI.getByUser(userId);
```

### C√°ch 3: Import Individual Functions

```javascript
import { apiRequest, getAuthToken } from '@/api';

// G·ªçi custom endpoint
const customData = await apiRequest('/api/custom-endpoint', {
  method: 'POST',
  body: { data: 'value' }
});

// L·∫•y token hi·ªán t·∫°i
const token = getAuthToken();
```

## üìö Chi Ti·∫øt C√°c API Modules

### 1. Authentication API (authAPI)

```javascript
// Login
await api.auth.login({ email: 'user@example.com', password: '123456' });

// Register
await api.auth.register({
  email: 'user@example.com',
  password: '123456',
  fullName: 'John Doe',
  phone: '0123456789'
});

// Refresh Token
await api.auth.refreshToken();

// Forgot Password
await api.auth.forgotPassword('user@example.com');

// Reset Password
await api.auth.resetPassword(resetToken, newPassword);
```

### 2. User API (userAPI)

```javascript
// Get all users (Admin)
const users = await api.user.getAll();

// Get user by ID
const user = await api.user.getById(userId);

// Update user
await api.user.update(userId, { fullName: 'New Name' });

// Delete user
await api.user.delete(userId);
```

### 3. Product API (productAPI)

```javascript
// Get all products
const products = await api.product.getAll();

// Get product by ID
const product = await api.product.getById(productId);

// Get products by seller
const sellerProducts = await api.product.getBySeller(sellerId);

// Create product
const newProduct = await api.product.create({
  name: 'Tesla Model 3',
  price: 1000000000,
  description: 'Electric car',
  // ... other fields
});

// Update product
await api.product.update(productId, { price: 900000000 });

// Delete product
await api.product.delete(productId);

// Approve product (Admin)
await api.product.approve(productId);

// Reject product (Admin)
await api.product.reject(productId, 'Not meeting requirements');

// Product Images
const images = await api.product.images.getByProduct(productId);
await api.product.images.upload(formData);
await api.product.images.uploadMultiple(formData);
await api.product.images.delete(imageId);
```

### 4. Order API (orderAPI)

```javascript
// Get all orders
const orders = await api.order.getAll();

// Get order by ID
const order = await api.order.getById(orderId);

// Get orders by user
const userOrders = await api.order.getByUser(userId);

// Create order
const newOrder = await api.order.create({
  userId: 1,
  productId: 5,
  totalAmount: 1000000000,
  // ... other fields
});

// Update order status
await api.order.updateStatus(orderId, 'Confirmed');

// Cancel order
await api.order.cancel(orderId);
```

### 5. Payment API (paymentAPI)

```javascript
// Create payment
const payment = await api.payment.create({
  orderId: 1,
  amount: 1000000000,
  paymentMethod: 'VNPay'
});

// Get payment by ID
const payment = await api.payment.getById(paymentId);

// Get payments by user
const payments = await api.payment.getByUser(userId);

// Update payment status
await api.payment.updateStatus(paymentId, 'Completed');

// Process VNPay payment (auto redirect)
await api.payment.processVNPay({
  orderId: 1,
  amount: 1000000000
});
```

### 6. Favorite API (favoriteAPI)

```javascript
// Get user favorites
const favorites = await api.favorite.getByUser(userId);

// Add to favorites
await api.favorite.add(userId, productId);

// Remove from favorites
await api.favorite.remove(userId, productId);

// Toggle favorite
await api.favorite.toggle(userId, productId);

// Check if favorited
const isFavorited = await api.favorite.isFavorited(userId, productId);
```

### 7. Notification API (notificationAPI)

```javascript
// Get user notifications
const notifications = await api.notification.getByUser(userId);

// Mark as read
await api.notification.markAsRead(notificationId);

// Mark all as read
await api.notification.markAllAsRead(userId);

// Create notification
await api.notification.create({
  userId: 1,
  title: 'New Message',
  message: 'You have a new message',
  type: 'info'
});
```

### 8. Chat API (chatAPI)

```javascript
// Get chat history
const chatHistory = await api.chat.getHistory(userId);

// Get messages
const messages = await api.chat.getMessages(conversationId);

// Send message
await api.chat.sendMessage({
  conversationId: 1,
  senderId: 1,
  message: 'Hello!',
  messageType: 'text'
});

// Create conversation
const conversation = await api.chat.createConversation([userId1, userId2]);
```

### 9. Review API (reviewAPI)

```javascript
// Get product reviews
const reviews = await api.review.getByProduct(productId);

// Get user reviews
const userReviews = await api.review.getByUser(userId);

// Create review
await api.review.create({
  productId: 1,
  userId: 1,
  rating: 5,
  comment: 'Great product!'
});

// Update review
await api.review.update(reviewId, { rating: 4 });

// Delete review
await api.review.delete(reviewId);
```

### 10. Verification API (verificationAPI)

```javascript
// Get verification requests (Admin)
const requests = await api.verification.getRequests();

// Request verification for vehicle
await api.verification.request(productId);

// Update verification status (Admin)
await api.verification.updateStatus(
  productId, 
  'Completed', 
  'Vehicle verified successfully'
);
```

### 11. Statistics API (statisticsAPI)

```javascript
// Get dashboard stats
const dashboardStats = await api.statistics.getDashboard(userId);

// Get admin stats
const adminStats = await api.statistics.getAdmin();

// Get product stats
const productStats = await api.statistics.getProduct(productId);

// Get sales stats
const salesStats = await api.statistics.getSales(sellerId);
```

### 12. Search API (searchAPI)

```javascript
// Search products
const products = await api.search.products({
  keyword: 'Tesla',
  minPrice: 500000000,
  maxPrice: 2000000000,
  category: 'Electric',
  sortBy: 'price',
  sortOrder: 'asc'
});

// Search users
const users = await api.search.users({
  keyword: 'john'
});
```

### 13. Category API (categoryAPI)

```javascript
// Get all categories
const categories = await api.category.getAll();

// Get category by ID
const category = await api.category.getById(categoryId);

// Create category
await api.category.create({ name: 'SUV', description: 'Sport Utility Vehicles' });

// Update category
await api.category.update(categoryId, { name: 'Electric SUV' });

// Delete category
await api.category.delete(categoryId);
```

### 14. System API (systemAPI)

```javascript
// Health check
const health = await api.system.healthCheck();

// Get system info
const info = await api.system.getInfo();
```

## üîß Custom API Requests

N·∫øu c·∫ßn g·ªçi custom endpoint kh√¥ng c√≥ trong modules:

```javascript
import { apiRequest } from '@/api';

const data = await apiRequest('/api/custom-endpoint', {
  method: 'POST',
  body: {
    field1: 'value1',
    field2: 'value2'
  },
  headers: {
    'Custom-Header': 'value'
  }
});
```

## ‚öôÔ∏è T·ª± ƒê·ªông X·ª≠ L√Ω

API Manager t·ª± ƒë·ªông x·ª≠ l√Ω:

1. **Authentication Token**: T·ª± ƒë·ªông th√™m Bearer token v√†o header
2. **Token Refresh**: T·ª± ƒë·ªông refresh token khi h·∫øt h·∫°n
3. **Error Handling**: X·ª≠ l√Ω l·ªói th·ªëng nh·∫•t v·ªõi message ti·∫øng Vi·ªát
4. **Content-Type**: T·ª± ƒë·ªông set `application/json` ho·∫∑c `multipart/form-data`
5. **CORS**: ƒê√£ c·∫•u h√¨nh ƒë√∫ng
6. **401 Redirect**: T·ª± ƒë·ªông redirect v·ªÅ login khi unauthorized

## üéØ Best Practices

### ‚úÖ DO (N√™n L√†m)

```javascript
// 1. S·ª≠ d·ª•ng try-catch ƒë·ªÉ x·ª≠ l√Ω l·ªói
try {
  const products = await api.product.getAll();
  console.log(products);
} catch (error) {
  console.error('Failed to fetch products:', error.message);
  // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho user
}

// 2. S·ª≠ d·ª•ng async/await thay v√¨ .then()
const handleLogin = async (credentials) => {
  try {
    const response = await api.auth.login(credentials);
    // Handle success
  } catch (error) {
    // Handle error
  }
};

// 3. Destructure response khi c·∫ßn
const { data, total, page } = await api.product.getAll();
```

### ‚ùå DON'T (Kh√¥ng N√™n)

```javascript
// 1. Kh√¥ng g·ªçi API trong loop
for (let id of productIds) {
  await api.product.getById(id); // ‚ùå Slow!
}

// Thay v√†o ƒë√≥, s·ª≠ d·ª•ng Promise.all
const products = await Promise.all(
  productIds.map(id => api.product.getById(id))
);

// 2. Kh√¥ng hardcode base URL
fetch('http://localhost:5044/api/Product'); // ‚ùå
api.product.getAll(); // ‚úÖ

// 3. Kh√¥ng t·ª± x·ª≠ l√Ω token
fetch('/api/Product', {
  headers: { Authorization: `Bearer ${token}` } // ‚ùå
});
api.product.getAll(); // ‚úÖ T·ª± ƒë·ªông th√™m token
```

## üîÑ Migration t·ª´ Code C≈©

### Tr∆∞·ªõc ƒë√¢y (nhi·ªÅu file r·∫£i r√°c)

```javascript
import { apiRequest } from '../lib/api';
import apiService from '../services/apiService';
import productService from '../services/productService';

// R·∫•t nhi·ªÅu imports kh√°c nhau
const products = await apiService.getAllProducts();
const product = await productService.getProductById(id);
```

### B√¢y gi·ªù (m·ªôt file duy nh·∫•t)

```javascript
import api from '@/api';

// T·∫•t c·∫£ ·ªü m·ªôt n∆°i
const products = await api.product.getAll();
const product = await api.product.getById(id);
```

## üìù Notes

- File c≈© (`src/lib/api.js`, `src/services/*`) v·∫´n c√≥ th·ªÉ d√πng t·∫°m th·ªùi
- N√™n migrate d·∫ßn sang `apiManager.js` ƒë·ªÉ code ƒë·ªìng nh·∫•t
- M·ªçi API ƒë·ªÅu c√≥ JSDoc comments ƒë·ªÉ IDE g·ª£i √Ω tham s·ªë
- Token ƒë∆∞·ª£c qu·∫£n l√Ω t·ª± ƒë·ªông b·ªüi `tokenManager`

## üÜò Troubleshooting

### L·ªói 401 Unauthorized
- Token ƒë√£ h·∫øt h·∫°n ‚Üí S·∫Ω t·ª± ƒë·ªông refresh
- N·∫øu refresh th·∫•t b·∫°i ‚Üí T·ª± ƒë·ªông redirect v·ªÅ `/login`

### L·ªói CORS
- ƒê·∫£m b·∫£o backend ƒë√£ enable CORS
- Check `VITE_API_BASE` trong `.env`

### API kh√¥ng ho·∫°t ƒë·ªông
- Check console ƒë·ªÉ xem request details
- Verify endpoint path ƒë√∫ng ch∆∞a
- Ki·ªÉm tra backend c√≥ running kh√¥ng

## üîó Related Files

- `src/api/apiManager.js` - Main API file
- `src/api/index.js` - Export module
- `src/lib/tokenManager.js` - Token management
- `src/config/api.js` - API configuration

