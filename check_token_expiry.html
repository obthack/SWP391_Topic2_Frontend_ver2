<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Token Expiry - EV Trading Platform</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .token-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .status-valid { color: #28a745; font-weight: bold; }
        .status-expired { color: #dc3545; font-weight: bold; }
        .status-expiring { color: #ffc107; font-weight: bold; }
        .time-display {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .progress-fill.expiring {
            background-color: #ffc107;
        }
        .progress-fill.expired {
            background-color: #dc3545;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .info-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Check Token Expiry - EV Trading Platform</h1>
        <p>Ki·ªÉm tra th·ªùi gian h·∫øt h·∫°n c·ªßa token hi·ªán t·∫°i trong localStorage.</p>
        
        <div class="info-box">
            <h3>üìã Th√¥ng tin v·ªÅ Token Expiry</h3>
            <ul>
                <li><strong>JWT Token th√¥ng th∆∞·ªùng:</strong> 15 ph√∫t - 24 gi·ªù</li>
                <li><strong>Development:</strong> 1-2 gi·ªù</li>
                <li><strong>Production:</strong> 30 ph√∫t - 2 gi·ªù</li>
                <li><strong>High Security:</strong> 5-15 ph√∫t</li>
            </ul>
        </div>

        <button onclick="checkCurrentToken()">Check Current Token</button>
        <button onclick="createTestTokens()">Create Test Tokens</button>
        <button onclick="clearToken()">Clear Token</button>

        <div id="token-result" class="token-info" style="display: none;"></div>
    </div>

    <script>
        function checkCurrentToken() {
            const resultDiv = document.getElementById('token-result');
            resultDiv.style.display = 'block';
            
            try {
                const authData = localStorage.getItem('evtb_auth');
                if (!authData) {
                    resultDiv.innerHTML = '<div class="status-expired">‚ùå No token found in localStorage</div>';
                    return;
                }

                const parsed = JSON.parse(authData);
                const token = parsed?.token;
                
                if (!token) {
                    resultDiv.innerHTML = '<div class="status-expired">‚ùå No token in auth data</div>';
                    return;
                }

                // Decode JWT token
                const parts = token.split('.');
                if (parts.length !== 3) {
                    resultDiv.innerHTML = '<div class="status-expired">‚ùå Invalid token format</div>';
                    return;
                }

                const payload = JSON.parse(atob(parts[1]));
                const currentTime = Math.floor(Date.now() / 1000);
                const issuedAt = new Date(payload.iat * 1000);
                const expiresAt = new Date(payload.exp * 1000);
                const timeLeft = Math.max(0, payload.exp - currentTime);
                const totalDuration = payload.exp - payload.iat;
                const timeUsed = totalDuration - timeLeft;
                const percentageUsed = (timeUsed / totalDuration) * 100;

                let statusClass = 'status-valid';
                let statusText = 'VALID';
                let progressClass = '';

                if (timeLeft <= 0) {
                    statusClass = 'status-expired';
                    statusText = 'EXPIRED';
                    progressClass = 'expired';
                } else if (timeLeft <= 300) { // 5 minutes
                    statusClass = 'status-expiring';
                    statusText = 'EXPIRING SOON';
                    progressClass = 'expiring';
                }

                const hoursLeft = Math.floor(timeLeft / 3600);
                const minutesLeft = Math.floor((timeLeft % 3600) / 60);
                const secondsLeft = timeLeft % 60;

                const totalHours = Math.floor(totalDuration / 3600);
                const totalMinutes = Math.floor((totalDuration % 3600) / 60);

                resultDiv.innerHTML = `
                    <h3>üîê Token Information</h3>
                    <div class="status-${statusClass}">
                        Status: ${statusText}
                    </div>
                    
                    <div class="time-display">
                        Time Left: ${hoursLeft > 0 ? hoursLeft + 'h ' : ''}${minutesLeft}m ${secondsLeft}s
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${percentageUsed}%"></div>
                    </div>
                    
                    <div><strong>Token ID:</strong> ${payload.sub || 'N/A'}</div>
                    <div><strong>User ID:</strong> ${payload.userId || 'N/A'}</div>
                    <div><strong>Email:</strong> ${payload.email || 'N/A'}</div>
                    <div><strong>Issued At:</strong> ${issuedAt.toLocaleString()}</div>
                    <div><strong>Expires At:</strong> ${expiresAt.toLocaleString()}</div>
                    <div><strong>Total Duration:</strong> ${totalHours > 0 ? totalHours + 'h ' : ''}${totalMinutes}m</div>
                    <div><strong>Time Used:</strong> ${Math.floor(timeUsed / 60)}m ${timeUsed % 60}s (${percentageUsed.toFixed(1)}%)</div>
                    
                    <div style="margin-top: 15px;">
                        <strong>Token Type:</strong> 
                        ${totalDuration <= 900 ? 'Short-lived (15 min or less)' : 
                          totalDuration <= 3600 ? 'Medium-lived (1 hour)' : 
                          totalDuration <= 7200 ? 'Long-lived (2 hours)' : 
                          'Very long-lived (2+ hours)'}
                    </div>
                `;

                // Auto-refresh display every second
                if (timeLeft > 0) {
                    setTimeout(() => {
                        checkCurrentToken();
                    }, 1000);
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="status-expired">‚ùå Error parsing token: ${error.message}</div>`;
            }
        }

        function createTestTokens() {
            const tokens = [
                {
                    name: 'Short Token (15 min)',
                    duration: 15 * 60, // 15 minutes
                    color: 'red'
                },
                {
                    name: 'Medium Token (1 hour)',
                    duration: 60 * 60, // 1 hour
                    color: 'orange'
                },
                {
                    name: 'Long Token (2 hours)',
                    duration: 2 * 60 * 60, // 2 hours
                    color: 'green'
                },
                {
                    name: 'Very Long Token (24 hours)',
                    duration: 24 * 60 * 60, // 24 hours
                    color: 'blue'
                }
            ];

            let html = '<h3>üß™ Test Tokens Created</h3>';
            
            tokens.forEach((token, index) => {
                const payload = {
                    sub: '1',
                    userId: 1,
                    email: 'test@example.com',
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + token.duration
                };
                
                const jwt = btoa(JSON.stringify({alg: 'HS256', typ: 'JWT'})) + '.' + 
                           btoa(JSON.stringify(payload)) + '.' + 
                           btoa('mock-signature');
                
                const authData = {
                    token: jwt,
                    user: {
                        id: 1,
                        email: 'test@example.com',
                        fullName: 'Test User'
                    }
                };
                
                // Store in localStorage with different keys
                localStorage.setItem(`evtb_auth_${index}`, JSON.stringify(authData));
                
                const hours = Math.floor(token.duration / 3600);
                const minutes = Math.floor((token.duration % 3600) / 60);
                
                html += `
                    <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${token.color}; background-color: #f8f9fa;">
                        <strong>${token.name}</strong><br>
                        Duration: ${hours > 0 ? hours + 'h ' : ''}${minutes}m<br>
                        <button onclick="loadTestToken(${index})" style="font-size: 12px; padding: 5px 10px;">Load This Token</button>
                    </div>
                `;
            });
            
            document.getElementById('token-result').innerHTML = html;
            document.getElementById('token-result').style.display = 'block';
        }

        function loadTestToken(index) {
            const authData = localStorage.getItem(`evtb_auth_${index}`);
            if (authData) {
                localStorage.setItem('evtb_auth', authData);
                checkCurrentToken();
            }
        }

        function clearToken() {
            localStorage.removeItem('evtb_auth');
            document.getElementById('token-result').innerHTML = '<div class="status-expired">‚ùå Token cleared from localStorage</div>';
            document.getElementById('token-result').style.display = 'block';
        }

        // Auto-check on page load
        window.onload = function() {
            console.log('üîê Token Expiry Checker Loaded');
            checkCurrentToken();
        };
    </script>
</body>
</html>
