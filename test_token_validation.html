<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Token Validation - EV Trading Platform</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .info { border-color: #2196F3; background-color: #e3f2fd; }
        .warning { border-color: #ff9800; background-color: #fff3e0; }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .log {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }
        .token-display {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Token Validation - EV Trading Platform</h1>
        <p>Test ƒë·ªÉ verify r·∫±ng token JWT ƒë∆∞·ª£c validate ƒë√∫ng c√°ch v√† x·ª≠ l√Ω h·∫øt h·∫°n.</p>
        
        <div class="test-section info">
            <h3>üìã Test Cases</h3>
            <ul>
                <li><strong>Valid Token:</strong> Token h·ª£p l·ªá v√† ch∆∞a h·∫øt h·∫°n</li>
                <li><strong>Expired Token:</strong> Token ƒë√£ h·∫øt h·∫°n</li>
                <li><strong>Invalid Token:</strong> Token kh√¥ng ƒë√∫ng format</li>
                <li><strong>Missing Token:</strong> Kh√¥ng c√≥ token</li>
                <li><strong>Token Refresh:</strong> T·ª± ƒë·ªông clear v√† redirect</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîç Test 1: Current Token Status</h3>
            <button onclick="checkCurrentToken()">Check Current Token</button>
            <div id="current-token-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 2: Create Test Tokens</h3>
            <button onclick="createValidToken()">Create Valid Token</button>
            <button onclick="createExpiredToken()">Create Expired Token</button>
            <button onclick="createInvalidToken()">Create Invalid Token</button>
            <div id="token-creation-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üîê Test 3: Token Validation</h3>
            <button onclick="testTokenValidation()">Test Token Validation</button>
            <button onclick="testExpiredToken()">Test Expired Token</button>
            <button onclick="testInvalidToken()">Test Invalid Token</button>
            <div id="validation-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ Test 4: Auto Redirect</h3>
            <button onclick="testAutoRedirect()">Test Auto Redirect</button>
            <div id="redirect-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div id="test-log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let testLog = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog.push(logMessage);
            document.getElementById('test-log').innerHTML = testLog.join('\n');
            console.log(logMessage);
        }

        function clearLog() {
            testLog = [];
            document.getElementById('test-log').innerHTML = '';
        }

        function createJWT(payload, secret = 'test-secret') {
            const header = {
                alg: 'HS256',
                typ: 'JWT'
            };
            
            const encodedHeader = btoa(JSON.stringify(header));
            const encodedPayload = btoa(JSON.stringify(payload));
            const signature = btoa('mock-signature');
            
            return `${encodedHeader}.${encodedPayload}.${signature}`;
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }
                
                const payload = JSON.parse(atob(parts[1]));
                return payload;
            } catch (error) {
                throw new Error('Invalid JWT token: ' + error.message);
            }
        }

        function checkCurrentToken() {
            const resultDiv = document.getElementById('current-token-result');
            resultDiv.innerHTML = 'Checking current token...';
            
            log("üîç Checking current token in localStorage");
            
            try {
                const authData = localStorage.getItem('evtb_auth');
                if (!authData) {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è No auth data found in localStorage
                        </div>
                    `;
                    log("‚ö†Ô∏è No auth data found");
                    return;
                }
                
                const parsed = JSON.parse(authData);
                const token = parsed?.token;
                
                if (!token) {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå No token found in auth data
                        </div>
                    `;
                    log("‚ùå No token found");
                    return;
                }
                
                const payload = decodeJWT(token);
                const currentTime = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp < currentTime;
                
                resultDiv.innerHTML = `
                    <div class="${isExpired ? 'error' : 'success'}">
                        ${isExpired ? '‚ùå' : '‚úÖ'} Token Status: ${isExpired ? 'EXPIRED' : 'VALID'}<br>
                        <strong>Token:</strong> ${token.substring(0, 50)}...<br>
                        <strong>Expires:</strong> ${payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'No expiration'}<br>
                        <strong>Current Time:</strong> ${new Date().toLocaleString()}<br>
                        <strong>User ID:</strong> ${payload.sub || payload.userId || 'N/A'}
                    </div>
                `;
                
                log(`${isExpired ? '‚ùå' : '‚úÖ'} Token is ${isExpired ? 'EXPIRED' : 'VALID'}`);
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error checking token: ${error.message}
                    </div>
                `;
                log(`‚ùå Error: ${error.message}`);
            }
        }

        function createValidToken() {
            const resultDiv = document.getElementById('token-creation-result');
            
            log("üß™ Creating valid token");
            
            const payload = {
                sub: '1',
                userId: 1,
                email: 'test@example.com',
                exp: Math.floor(Date.now() / 1000) + 3600, // 1 hour from now
                iat: Math.floor(Date.now() / 1000)
            };
            
            const token = createJWT(payload);
            const authData = {
                token: token,
                user: {
                    id: 1,
                    email: 'test@example.com',
                    fullName: 'Test User'
                }
            };
            
            localStorage.setItem('evtb_auth', JSON.stringify(authData));
            
            resultDiv.innerHTML = `
                <div class="success">
                    ‚úÖ Valid token created and stored<br>
                    <strong>Expires:</strong> ${new Date(payload.exp * 1000).toLocaleString()}<br>
                    <div class="token-display">${token}</div>
                </div>
            `;
            
            log("‚úÖ Valid token created");
        }

        function createExpiredToken() {
            const resultDiv = document.getElementById('token-creation-result');
            
            log("üß™ Creating expired token");
            
            const payload = {
                sub: '1',
                userId: 1,
                email: 'test@example.com',
                exp: Math.floor(Date.now() / 1000) - 3600, // 1 hour ago
                iat: Math.floor(Date.now() / 1000) - 7200
            };
            
            const token = createJWT(payload);
            const authData = {
                token: token,
                user: {
                    id: 1,
                    email: 'test@example.com',
                    fullName: 'Test User'
                }
            };
            
            localStorage.setItem('evtb_auth', JSON.stringify(authData));
            
            resultDiv.innerHTML = `
                <div class="error">
                    ‚ùå Expired token created and stored<br>
                    <strong>Expired:</strong> ${new Date(payload.exp * 1000).toLocaleString()}<br>
                    <div class="token-display">${token}</div>
                </div>
            `;
            
            log("‚ùå Expired token created");
        }

        function createInvalidToken() {
            const resultDiv = document.getElementById('token-creation-result');
            
            log("üß™ Creating invalid token");
            
            const invalidToken = 'invalid.token.format';
            const authData = {
                token: invalidToken,
                user: {
                    id: 1,
                    email: 'test@example.com',
                    fullName: 'Test User'
                }
            };
            
            localStorage.setItem('evtb_auth', JSON.stringify(authData));
            
            resultDiv.innerHTML = `
                <div class="error">
                    ‚ùå Invalid token created and stored<br>
                    <div class="token-display">${invalidToken}</div>
                </div>
            `;
            
            log("‚ùå Invalid token created");
        }

        function testTokenValidation() {
            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = 'Testing token validation...';
            
            log("üß™ Testing token validation");
            
            try {
                const authData = localStorage.getItem('evtb_auth');
                if (!authData) {
                    throw new Error('No auth data');
                }
                
                const parsed = JSON.parse(authData);
                const token = parsed?.token;
                if (!token) {
                    throw new Error('No token');
                }
                
                const payload = decodeJWT(token);
                const currentTime = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp < currentTime;
                
                if (isExpired) {
                    throw new Error('Token expired');
                }
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Token validation passed<br>
                        Token is valid and not expired
                    </div>
                `;
                
                log("‚úÖ Token validation passed");
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Token validation failed: ${error.message}
                    </div>
                `;
                log(`‚ùå Token validation failed: ${error.message}`);
            }
        }

        function testExpiredToken() {
            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = 'Testing expired token...';
            
            log("üß™ Testing expired token handling");
            
            try {
                const authData = localStorage.getItem('evtb_auth');
                const parsed = JSON.parse(authData);
                const token = parsed?.token;
                const payload = decodeJWT(token);
                const currentTime = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp < currentTime;
                
                if (isExpired) {
                    // Simulate clearing auth data
                    localStorage.removeItem('evtb_auth');
                    
                    resultDiv.innerHTML = `
                        <div class="warning">
                            ‚ö†Ô∏è Expired token detected<br>
                            Auth data cleared from localStorage<br>
                            Should redirect to login page
                        </div>
                    `;
                    
                    log("‚ö†Ô∏è Expired token handled - auth data cleared");
                } else {
                    resultDiv.innerHTML = `
                        <div class="info">
                            ‚ÑπÔ∏è Token is not expired<br>
                            Current token is still valid
                        </div>
                    `;
                    
                    log("‚ÑπÔ∏è Token is not expired");
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error testing expired token: ${error.message}
                    </div>
                `;
                log(`‚ùå Error: ${error.message}`);
            }
        }

        function testInvalidToken() {
            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = 'Testing invalid token...';
            
            log("üß™ Testing invalid token handling");
            
            try {
                const authData = localStorage.getItem('evtb_auth');
                const parsed = JSON.parse(authData);
                const token = parsed?.token;
                const payload = decodeJWT(token);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Token is valid<br>
                        Unexpected: invalid token was actually valid
                    </div>
                `;
                
                log("‚úÖ Token is valid");
            } catch (error) {
                // Simulate clearing auth data for invalid token
                localStorage.removeItem('evtb_auth');
                
                resultDiv.innerHTML = `
                    <div class="warning">
                        ‚ö†Ô∏è Invalid token detected<br>
                        Error: ${error.message}<br>
                        Auth data cleared from localStorage<br>
                        Should redirect to login page
                    </div>
                `;
                
                log(`‚ö†Ô∏è Invalid token handled - auth data cleared: ${error.message}`);
            }
        }

        function testAutoRedirect() {
            const resultDiv = document.getElementById('redirect-result');
            resultDiv.innerHTML = 'Testing auto redirect...';
            
            log("üß™ Testing auto redirect functionality");
            
            resultDiv.innerHTML = `
                <div class="info">
                    üîÑ Auto redirect test<br>
                    <br>
                    In a real application, this would:<br>
                    1. Detect expired/invalid token<br>
                    2. Clear localStorage<br>
                    3. Show user-friendly message<br>
                    4. Redirect to /login after 1-2 seconds<br>
                    <br>
                    <strong>Simulated redirect:</strong> <span id="countdown">3</span> seconds
                </div>
            `;
            
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            
            const interval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(interval);
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Auto redirect test completed<br>
                            Would redirect to: /login
                        </div>
                    `;
                    log("‚úÖ Auto redirect test completed");
                }
            }, 1000);
        }

        // Auto-test on page load
        window.onload = function() {
            log('üß™ Token Validation Test Page Loaded');
            log('üìã Test Cases:');
            log('  - Valid Token: Should pass validation');
            log('  - Expired Token: Should clear auth data');
            log('  - Invalid Token: Should clear auth data');
            log('  - Auto Redirect: Should redirect to login');
        };
    </script>
</body>
</html>
